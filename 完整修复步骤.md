# å®Œæ•´ä¿®å¤æ­¥éª¤ - Supabase ç™»å½•é—®é¢˜

## ğŸ¯ é—®é¢˜æ ¹æº

ä»æ—¥å¿—ä¸­å‘ç°äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š
1. **é‡å®šå‘ URL é”™è¯¯**: æ˜¾ç¤º `https://0.0.0.0:3000` è€Œä¸æ˜¯ `https://lunyee.cn`
2. **Invalid flow state**: Cookie åŸŸåé…ç½®ä¸æ­£ç¡®

## âœ… ä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šé…ç½® Supabase é¡¹ç›®

1. è®¿é—® https://supabase.com å¹¶ç™»å½•
2. è¿›å…¥æ‚¨çš„é¡¹ç›®ï¼ˆbamcwwtwtvxjjcdfbmdrï¼‰
3. ç‚¹å‡»å·¦ä¾§èœå• **Authentication** â†’ **URL Configuration**

**é…ç½®ä»¥ä¸‹è®¾ç½®ï¼š**

**Site URLï¼ˆç«™ç‚¹ URLï¼‰ï¼š**
```
https://lunyee.cn
```

**Redirect URLsï¼ˆé‡å®šå‘ URLï¼‰- ç‚¹å‡» "Add URL" æ·»åŠ ä»¥ä¸‹æ‰€æœ‰ URLï¼š**
```
https://lunyee.cn/**
https://www.lunyee.cn/**
https://lunyee.cn/zh/auth/callback
https://lunyee.cn/en/auth/callback
https://lunyee.cn/zh/**
https://lunyee.cn/en/**
```

4. ç‚¹å‡» **Save** ä¿å­˜è®¾ç½®

---

### ç¬¬äºŒæ­¥ï¼šåœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²æœ€æ–°ä»£ç 

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/11flow

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 3. è¿›å…¥å‰ç«¯ç›®å½•
cd frontend

# 4. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœæœ‰æ›´æ–°ï¼‰
npm install --legacy-peer-deps

# 5. æ¸…ç†æ—§æ„å»º
rm -rf .next

# 6. é‡æ–°æ„å»º
npm run build

# 7. é‡å¯å‰ç«¯æœåŠ¡
pm2 restart frontend --update-env

# 8. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ²¡æœ‰é”™è¯¯
pm2 logs frontend --lines 50
```

---

### ç¬¬ä¸‰æ­¥ï¼šæ¸…é™¤æµè§ˆå™¨ Cookie

**é‡è¦ï¼** ç”±äº Cookie åŸŸåé…ç½®å·²æ›´æ”¹ï¼Œæ‚¨éœ€è¦æ¸…é™¤æµè§ˆå™¨ä¸­çš„æ—§ Cookieï¼š

**Chrome/Edge:**
1. è®¿é—® `https://lunyee.cn`
2. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
3. è¿›å…¥ **Application** æ ‡ç­¾
4. å·¦ä¾§ç‚¹å‡» **Cookies** â†’ `https://lunyee.cn`
5. å³é”®ç‚¹å‡»æ‰€æœ‰ Cookie â†’ **Clear**
6. åˆ·æ–°é¡µé¢

**æˆ–è€…ä½¿ç”¨éšèº«/æ— ç—•æ¨¡å¼æµ‹è¯•**

---

### ç¬¬å››æ­¥ï¼šæµ‹è¯•ç™»å½•

1. è®¿é—® `https://lunyee.cn/zh/login`
2. ç‚¹å‡»ç™»å½•æŒ‰é’®
3. å®Œæˆ OAuth è®¤è¯
4. åº”è¯¥æˆåŠŸé‡å®šå‘åˆ°é¦–é¡µï¼Œä¸å†å‡ºç° 502 é”™è¯¯

---

## ğŸ” éªŒè¯ä¿®å¤

### æ£€æŸ¥æ—¥å¿—ä¸­çš„æˆåŠŸæ¶ˆæ¯

æ‰§è¡Œï¼š
```bash
pm2 logs frontend --lines 50
```

**åº”è¯¥çœ‹åˆ°ï¼š**
```
[Auth Callback] Received request: {
  code: '...',
  origin: 'https://lunyee.cn',    â† æ­£ç¡®çš„åŸŸå
  next: '/zh',
  env: 'production'
}
[Auth Callback] Supabase client created, exchanging code...
[Auth Callback] Session created successfully for user: your@email.com
[Auth Callback] Redirecting to: https://lunyee.cn/zh    â† æ­£ç¡®çš„é‡å®šå‘
```

### æ£€æŸ¥ PM2 çŠ¶æ€

```bash
pm2 status
```

ç¡®ä¿ frontend çŠ¶æ€ä¸º **online**

---

## ğŸ› ï¸ å¦‚æœä»ç„¶æœ‰é—®é¢˜

### é—®é¢˜ 1: ä»ç„¶çœ‹åˆ° "invalid flow state"

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤ Supabase é…ç½®å·²ä¿å­˜
2. æ¸…é™¤æµè§ˆå™¨æ‰€æœ‰ Cookie
3. ä½¿ç”¨éšèº«æ¨¡å¼æµ‹è¯•
4. ç­‰å¾… 1-2 åˆ†é’Ÿè®© Supabase é…ç½®ç”Ÿæ•ˆ

### é—®é¢˜ 2: é‡å®šå‘åˆ°é”™è¯¯çš„ URL

**æ£€æŸ¥ï¼š**
```bash
cd /var/www/11flow/frontend
cat .env.local | grep SITE_URL
```

åº”è¯¥æ˜¾ç¤ºï¼š
```
NEXT_PUBLIC_SITE_URL=https://lunyee.cn
```

å¦‚æœä¸å¯¹ï¼Œä¿®æ”¹åé‡æ–°æ„å»ºï¼š
```bash
npm run build
pm2 restart frontend --update-env
```

### é—®é¢˜ 3: æ„å»ºå¤±è´¥

**æŸ¥çœ‹å®Œæ•´é”™è¯¯ï¼š**
```bash
npm run build 2>&1 | tee build.log
cat build.log
```

---

## ğŸ“ æŠ€æœ¯è¯´æ˜

### ä¿®å¤å†…å®¹

1. **middleware.ts** - æ·»åŠ äº†ç”Ÿäº§ç¯å¢ƒ Cookie åŸŸåé…ç½®
2. **server.ts** - å·²é…ç½® Cookie åŸŸåä¸º `.lunyee.cn`
3. **callback/route.ts** - å¢å¼ºäº†é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### Cookie é…ç½®

```typescript
const cookieOptions = {
    ...options,
    domain: '.lunyee.cn',      // å…è®¸å­åŸŸåå…±äº«
    sameSite: 'lax',           // è·¨ç«™è¯·æ±‚ä¿æŠ¤
    secure: true,              // ä»… HTTPS
};
```

---

## âœ¨ æ€»ç»“

ä¿®å¤åŒ…å«ä¸‰ä¸ªå…³é”®æ­¥éª¤ï¼š
1. âœ… åœ¨ Supabase æ§åˆ¶å°é…ç½®æ­£ç¡®çš„ Site URL å’Œ Redirect URLs
2. âœ… éƒ¨ç½²åŒ…å« Cookie åŸŸåä¿®å¤çš„æœ€æ–°ä»£ç 
3. âœ… æ¸…é™¤æµè§ˆå™¨æ—§ Cookie åé‡æ–°æµ‹è¯•

å®Œæˆè¿™äº›æ­¥éª¤åï¼Œç™»å½•åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œï¼
