# 修复生产环境登录 502 错误 - 完整指南

## 📋 问题描述

您的生产网站 `lunyee.cn` 在用户尝试通过 Supabase OAuth 登录时出现 **502 Bad Gateway** 错误。

**错误详情：**
- 错误页面：`https://lunyee.cn/en/auth/callback?code=...`
- 状态码：502 Bad Gateway
- 影响：用户无法完成登录流程

---

## 🔍 根本原因

根据之前的调试历史，这个问题与 **Supabase Cookie 配置**有关：

1. **Cookie 域名配置缺失**：Cookie 没有正确配置为 `.lunyee.cn` 域名
2. **错误日志不足**：无法看到认证回调过程中发生了什么
3. **异常未处理**：回调路由中的错误没有被捕获，导致 502 响应

---

## ✅ 已实施的修复

### 1. 增强 Supabase 服务端客户端配置

**文件：** `frontend/src/utils/supabase/server.ts`

**修改内容：**
- 为生产环境添加 Cookie 域名配置（`.lunyee.cn`）
- 设置 `sameSite: 'lax'` 以支持跨域兼容性
- 在生产环境启用 `secure: true` 标志（仅 HTTPS）
- 添加 Cookie 操作的错误日志

**关键代码：**
```typescript
const cookieOptions = {
    ...options,
    domain: process.env.NODE_ENV === 'production' 
        ? '.lunyee.cn'  // 生产环境使用您的域名
        : undefined,     // 本地开发不设置域名
    sameSite: 'lax' as const,
    secure: process.env.NODE_ENV === 'production',
};
```

**为什么重要：**
- 确保 Cookie 在子域名间正常工作
- 防止 Supabase 认证中常见的 "invalid flow state" 错误
- 在生产环境中保持安全性（仅 HTTPS）

---

### 2. 增强认证回调错误处理

**文件：** `frontend/src/app/[locale]/auth/callback/route.ts`

**修改内容：**
- 用完整的 try-catch 块包裹认证逻辑
- 在认证流程的每个步骤添加详细日志
- 改进传递给错误页面的错误消息
- 添加会话数据验证

**关键改进：**
```typescript
console.log('[Auth Callback] 收到请求:', { 
    code: code?.substring(0, 10) + '...', 
    origin, 
    next,
    env: process.env.NODE_ENV 
});

try {
    const supabase = await createClient();
    const { data, error } = await supabase.auth.exchangeCodeForSession(code);
    
    if (!error && data.session) {
        console.log('[Auth Callback] 会话创建成功');
        // ... 重定向逻辑
    } else {
        // 详细的错误日志和用户友好的错误页面
    }
} catch (err) {
    console.error("[Auth Callback] 捕获异常:", err);
    // 优雅的错误处理
}
```

**好处：**
- 通过 PM2 日志可以看到认证流程失败的原因
- 优雅的错误处理防止 502 错误
- 用户看到有用的错误消息而不是通用的服务器错误

---

### 3. 部署自动化脚本

创建了两个辅助脚本用于生产环境维护：

#### `deploy-frontend.sh` - 部署脚本
自动化部署流程：
1. 从 Git 拉取最新代码
2. 安装依赖
3. 清理构建缓存
4. 重新构建前端
5. 重启 PM2 服务

#### `diagnose-production.sh` - 诊断脚本
快速诊断工具，检查：
- PM2 进程状态
- 端口可用性
- Nginx 状态
- 最近的日志
- 环境变量

---

## 🚀 部署步骤（重要！）

### 第一步：SSH 登录到生产服务器

```bash
# 使用您的服务器 IP 或域名
ssh root@您的服务器IP

# 或者如果您配置了 SSH 别名
ssh your-server-alias
```

### 第二步：运行诊断（可选但推荐）

在部署前先看看当前系统状态：

```bash
cd /var/www/11flow
./diagnose-production.sh
```

这会显示：
- ✓ PM2 进程是否在运行
- ✓ 端口是否正常监听
- ✓ Nginx 状态
- ✓ 最近的错误日志

### 第三步：执行部署

```bash
cd /var/www/11flow
./deploy-frontend.sh
```

**脚本会自动完成以下操作：**

```
==========================================
11Flow 生产环境部署脚本
==========================================

步骤 1/6: 进入项目目录
✓ 当前目录: /var/www/11flow

步骤 2/6: 拉取最新代码
✓ 代码已更新

步骤 3/6: 检查前端依赖
✓ 依赖已更新

步骤 4/6: 清理并重新构建前端
✓ 构建完成

步骤 5/6: 重启前端服务
✓ 前端服务已重启

步骤 6/6: 检查服务状态
[显示 PM2 状态表，frontend 应该是 'online']

==========================================
部署完成！
==========================================
```

### 第四步：监控日志

部署后，观察日志确保没有错误：

```bash
pm2 logs frontend --lines 50
```

**查找这些新的日志消息：**
- ✓ `[Auth Callback] 收到请求:`
- ✓ `[Auth Callback] Supabase 客户端已创建，正在交换代码...`
- ✓ `[Auth Callback] 会话创建成功`

### 第五步：测试登录流程

1. 打开浏览器访问 `https://lunyee.cn/zh/login`
2. 点击登录按钮
3. 完成 Supabase OAuth 流程
4. 验证成功重定向到首页
5. 确认没有 502 错误

---

## 🎯 预期结果

### 修复前
- ❌ 认证回调时出现 502 Bad Gateway
- ❌ 看不到错误日志
- ❌ 用户无法登录

### 修复后
- ✅ 认证回调成功完成
- ✅ 可以查看详细的调试日志
- ✅ 用户可以正常登录
- ✅ 会话正确保持

---

## 🔧 故障排除

### 如果 502 错误仍然存在

**1. 检查 PM2 状态：**
```bash
pm2 status
```
确保 frontend 显示为 "online"

**2. 查看错误日志：**
```bash
pm2 logs frontend --lines 100
```
查找任何错误消息

**3. 验证环境变量：**
```bash
cd /var/www/11flow/frontend
cat .env.local | grep SUPABASE
```
确保 `NEXT_PUBLIC_SUPABASE_URL` 和 `NEXT_PUBLIC_SUPABASE_ANON_KEY` 已设置

**4. 检查 Nginx 日志：**
```bash
tail -n 50 /var/log/nginx/error.log
```

**5. 重启所有服务：**
```bash
pm2 restart all
systemctl restart nginx
```

### 常见问题

**问题：** 部署后出现 "Module not found" 错误
- **解决方案：** 运行 `npm install --legacy-peer-deps` 然后重新构建

**问题：** 环境变量没有更新
- **解决方案：** 使用 `pm2 restart frontend --update-env`

**问题：** 仍然看到旧的行为
- **解决方案：** 清除浏览器 Cookie 后重试

**问题：** 构建失败
- **解决方案：** 检查 Node.js 版本（需要 v18 或更高），运行 `node -v` 确认

---

## 📝 技术细节

### Cookie 域名配置

修复将生产环境的 Cookie 域名设置为 `.lunyee.cn`，这样做：
- ✓ 允许 Cookie 在 `www.lunyee.cn` 和 `lunyee.cn` 之间工作
- ✓ 确保 Supabase 认证状态正确保持
- ✓ 防止 "invalid flow state" 错误

### 安全考虑

- Cookie 在生产环境标记为 `secure: true`（仅 HTTPS）
- `sameSite: 'lax'` 在安全性和功能性之间提供良好平衡
- 错误消息不暴露敏感信息

---

## 📞 需要帮助？

如果部署过程中遇到问题，请提供以下信息：

1. **PM2 状态：**
   ```bash
   pm2 status
   ```

2. **前端日志：**
   ```bash
   pm2 logs frontend --lines 100 --nostream
   ```

3. **Nginx 错误日志：**
   ```bash
   tail -n 50 /var/log/nginx/error.log
   ```

4. **具体的错误消息或截图**

---

## ✨ 总结

这次修复通过以下方式解决了 502 Bad Gateway 错误的根本原因：

1. ✅ 为生产域名正确配置 Supabase Cookie
2. ✅ 添加全面的错误处理和日志记录
3. ✅ 提供部署自动化工具

修改量小、重点突出，并且基于之前调试会话中验证过的解决方案。增强的日志记录将使未来的问题更容易诊断。

**现在就去部署吧！祝您好运！🚀**
