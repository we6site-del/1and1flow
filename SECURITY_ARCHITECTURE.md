# ğŸ” å®‰å…¨æ¶æ„è¯¦è§£ - API å¯†é’¥ä¿æŠ¤

## æ ¸å¿ƒåŸåˆ™ï¼šAPI å¯†é’¥æ°¸è¿œä¸ç¦»å¼€åç«¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (Next.js)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Refine Admin (/admin/ai-models)                         â”‚  â”‚
â”‚  â”‚  âœ… é…ç½®: name, api_path, cost, parameters_schema       â”‚  â”‚
â”‚  â”‚  âŒ ä¸å­˜å‚¨: API å¯†é’¥                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç”Ÿæˆå™¨èŠ‚ç‚¹ (Canvas)                                      â”‚  â”‚
â”‚  â”‚  âœ… è¯»å–: æ¨¡å‹åˆ—è¡¨ï¼ˆä» Supabaseï¼‰                        â”‚  â”‚
â”‚  â”‚  âœ… æ˜¾ç¤º: åŠ¨æ€è¡¨å•ï¼ˆæ ¹æ® parameters_schemaï¼‰             â”‚  â”‚
â”‚  â”‚  âœ… å‘é€: { model_id, prompt, parameters }               â”‚  â”‚
â”‚  â”‚  âŒ ä¸åŒ…å«: API å¯†é’¥                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP POST /api/generate
                            â”‚ { model_id, prompt, parameters }
                            â”‚ (ä¸åŒ…å« API å¯†é’¥)
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ (Python FastAPI)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç¯å¢ƒå˜é‡ (.env)                                          â”‚  â”‚
â”‚  â”‚  âœ… FAL_KEY=xxx (åªå­˜åœ¨äºåç«¯)                           â”‚  â”‚
â”‚  â”‚  âœ… REPLICATE_API_TOKEN=xxx (åªå­˜åœ¨äºåç«¯)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                     â”‚
â”‚                            â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /api/generate å¤„ç†æµç¨‹                                   â”‚  â”‚
â”‚  â”‚  1. æ ¹æ® model_id æŸ¥è¯¢æ•°æ®åº“ â†’ è·å– api_path, provider  â”‚  â”‚
â”‚  â”‚  2. ä»ç¯å¢ƒå˜é‡è¯»å–å¯¹åº” API å¯†é’¥                           â”‚  â”‚
â”‚  â”‚  3. è°ƒç”¨ Fal.ai æˆ– Replicate (ä½¿ç”¨åç«¯å¯†é’¥)             â”‚  â”‚
â”‚  â”‚  4. è¿”å›ç»“æœ URL                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬ä¸‰æ–¹ API                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚  Fal.ai      â”‚  â”‚  Replicate   â”‚                            â”‚
â”‚  â”‚  (ä½¿ç”¨ FAL_KEY)â”‚  â”‚  (ä½¿ç”¨ REPLICATE_API_TOKEN)            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®å­˜å‚¨ä½ç½®å¯¹æ¯”

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | æ˜¯å¦æš´éœ² | è¯´æ˜ |
|---------|---------|---------|------|
| **æ¨¡å‹åç§°** | Supabase `ai_models.name` | âœ… å…¬å¼€ | å¦‚ "Kling 2.1 Master" |
| **API è·¯å¾„** | Supabase `ai_models.api_path` | âœ… å…¬å¼€ | å¦‚ "kling-ai/kling-video-v2"ï¼ˆç±»ä¼¼ GitHub è·¯å¾„ï¼‰ |
| **æä¾›å•†** | Supabase `ai_models.provider` | âœ… å…¬å¼€ | "REPLICATE" æˆ– "FAL" |
| **ä»·æ ¼** | Supabase `ai_models.cost_per_gen` | âœ… å…¬å¼€ | ç§¯åˆ†æ•°é‡ |
| **å‚æ•° Schema** | Supabase `ai_models.parameters_schema` | âœ… å…¬å¼€ | UI å®šä¹‰ JSON |
| **FAL_KEY** | åç«¯ç¯å¢ƒå˜é‡ | âŒ **ç»ä¸æš´éœ²** | åªå­˜åœ¨äº `backend/.env` |
| **REPLICATE_API_TOKEN** | åç«¯ç¯å¢ƒå˜é‡ | âŒ **ç»ä¸æš´éœ²** | åªå­˜åœ¨äº `backend/.env` |

## ğŸ” ä»£ç éªŒè¯

### âœ… å‰ç«¯ä»£ç æ£€æŸ¥

**å‰ç«¯ Refine Admin è¡¨å•** (`frontend/src/components/admin/AiModelForm.tsx`):
```typescript
// âœ… åªæ”¶é›†å…¬å¼€çš„å…ƒæ•°æ®
const formData = {
    name: "",           // âœ… å…¬å¼€
    api_path: "",      // âœ… å…¬å¼€ï¼ˆæ¨¡å‹è·¯å¾„ï¼Œä¸æ˜¯å¯†é’¥ï¼‰
    provider: "",      // âœ… å…¬å¼€
    cost_per_gen: 0,  // âœ… å…¬å¼€
    parameters_schema: [] // âœ… å…¬å¼€
    // âŒ æ²¡æœ‰ API å¯†é’¥å­—æ®µ
};
```

**å‰ç«¯ç”Ÿæˆè¯·æ±‚** (`frontend/src/components/canvas/shapes/AiNodeShape.tsx`):
```typescript
// âœ… åªå‘é€ model_id å’Œå‚æ•°ï¼Œä¸å‘é€å¯†é’¥
fetch("http://localhost:8000/api/generate", {
    body: JSON.stringify({
        model_id: modelId,      // âœ… UUIDï¼Œä¸æ˜¯å¯†é’¥
        prompt: prompt,         // âœ… ç”¨æˆ·è¾“å…¥
        parameters: parameters, // âœ… ç”¨æˆ·é€‰æ‹©çš„å‚æ•°
        // âŒ ä¸åŒ…å«ä»»ä½• API å¯†é’¥
    }),
});
```

### âœ… åç«¯ä»£ç æ£€æŸ¥

**åç«¯ç¯å¢ƒå˜é‡è¯»å–** (`backend/services/fal_ai.py`):
```python
# âœ… API å¯†é’¥åªä»ç¯å¢ƒå˜é‡è¯»å–ï¼ˆåç«¯ï¼‰
FAL_KEY = os.getenv("FAL_KEY")  # åªå­˜åœ¨äºåç«¯ .env
```

**åç«¯ç”Ÿæˆå¤„ç†** (`backend/routers/generate.py`):
```python
# âœ… ä»æ•°æ®åº“è¯»å–å…¬å¼€ä¿¡æ¯
model_config = supabase.table("ai_models").select("*").eq("id", model_id).execute()
api_path = model_config["api_path"]  # âœ… å…¬å¼€çš„æ¨¡å‹è·¯å¾„

# âœ… ä»ç¯å¢ƒå˜é‡è¯»å–å¯†é’¥ï¼ˆåç«¯ï¼‰
if provider == "REPLICATE":
    # ä½¿ç”¨åç«¯ç¯å¢ƒå˜é‡ä¸­çš„ REPLICATE_API_TOKEN
    replicate_client = replicate.Client(api_token=os.getenv("REPLICATE_API_TOKEN"))
```

## ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤å±‚

### ç¬¬ 1 å±‚ï¼šæ•°æ®åº“ RLS
```sql
-- æ™®é€šç”¨æˆ·åªèƒ½è¯»å–æ´»è·ƒæ¨¡å‹ï¼ˆç”¨äºé€‰æ‹©ï¼‰
CREATE POLICY "Anyone can view active models" 
ON ai_models FOR SELECT USING (is_active = true);

-- åªæœ‰ Service Role å¯ä»¥å†™å…¥ï¼ˆç®¡ç†å‘˜é…ç½®ï¼‰
CREATE POLICY "Service role can manage models" 
ON ai_models FOR ALL 
USING (auth.jwt() ->> 'role' = 'service_role');
```

### ç¬¬ 2 å±‚ï¼šç¯å¢ƒå˜é‡éš”ç¦»
- å‰ç«¯ï¼šåªä½¿ç”¨ `NEXT_PUBLIC_` å‰ç¼€çš„å…¬å¼€å˜é‡
- åç«¯ï¼šæ‰€æœ‰æ•æ„Ÿå¯†é’¥éƒ½åœ¨ `.env` ä¸­ï¼Œä¸æäº¤åˆ° Git

### ç¬¬ 3 å±‚ï¼šAPI è·¯ç”±ä¿æŠ¤
- å‰ç«¯åªèƒ½è°ƒç”¨ `/api/generate`ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ Fal.ai æˆ– Replicate
- æ‰€æœ‰ç¬¬ä¸‰æ–¹ API è°ƒç”¨éƒ½åœ¨åç«¯å®Œæˆ

## ğŸ“ å®é™…é…ç½®ç¤ºä¾‹

### ç®¡ç†å‘˜åœ¨ Refine Admin ä¸­é…ç½®æ¨¡å‹

**è¾“å…¥å†…å®¹ï¼ˆéƒ½æ˜¯å…¬å¼€ä¿¡æ¯ï¼‰ï¼š**
```json
{
  "name": "Kling 2.1 Master",
  "type": "VIDEO",
  "provider": "REPLICATE",
  "api_path": "kling-ai/kling-video-v2",  // â† è¿™æ˜¯å…¬å¼€çš„æ¨¡å‹è·¯å¾„
  "cost_per_gen": 160,
  "parameters_schema": [
    {
      "key": "duration",
      "type": "select",
      "options": [{"label": "5s", "value": "5s"}]
    }
  ]
}
```

**âŒ ç®¡ç†å‘˜ä¸éœ€è¦è¾“å…¥ï¼ˆä¹Ÿä¸åº”è¯¥è¾“å…¥ï¼‰ï¼š**
- `REPLICATE_API_TOKEN` â† è¿™ä¸ªåœ¨åç«¯ç¯å¢ƒå˜é‡ä¸­
- `FAL_KEY` â† è¿™ä¸ªåœ¨åç«¯ç¯å¢ƒå˜é‡ä¸­

### åç«¯å¦‚ä½•ä½¿ç”¨

```python
# 1. æ¥æ”¶å‰ç«¯è¯·æ±‚ï¼ˆä¸åŒ…å«å¯†é’¥ï¼‰
request = {
    "model_id": "uuid-123",
    "prompt": "a cat",
    "parameters": {"duration": "5s"}
}

# 2. æŸ¥è¯¢æ•°æ®åº“è·å–æ¨¡å‹ä¿¡æ¯ï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰
model = supabase.table("ai_models").select("*").eq("id", request.model_id).execute()
api_path = model["api_path"]  # "kling-ai/kling-video-v2"
provider = model["provider"]  # "REPLICATE"

# 3. ä»ç¯å¢ƒå˜é‡è¯»å–å¯†é’¥ï¼ˆåç«¯ç§æœ‰ï¼‰
if provider == "REPLICATE":
    token = os.getenv("REPLICATE_API_TOKEN")  # â† ä»åç«¯ .env è¯»å–
    client = replicate.Client(api_token=token)
    result = client.run(api_path, input={...})
```

## âœ… æ€»ç»“

1. **åå°ç®¡ç†ç³»ç»Ÿä½ç½®**ï¼š
   - âœ… å‰ç«¯ï¼šRefine Admin UI (`frontend/src/app/admin/`)
   - âœ… åç«¯ï¼šAPI å¤„ç†é€»è¾‘ (`backend/routers/generate.py`)

2. **API å¯†é’¥å®‰å…¨**ï¼š
   - âœ… å¯†é’¥åªå­˜åœ¨äºåç«¯ç¯å¢ƒå˜é‡
   - âœ… æ•°æ®åº“åªå­˜å‚¨å…¬å¼€çš„æ¨¡å‹è·¯å¾„ï¼ˆ`api_path`ï¼‰
   - âœ… å‰ç«¯æ°¸è¿œæ— æ³•è®¿é—® API å¯†é’¥
   - âœ… æ‰€æœ‰ç¬¬ä¸‰æ–¹ API è°ƒç”¨éƒ½åœ¨åç«¯å®Œæˆ

3. **æ¶æ„ä¼˜åŠ¿**ï¼š
   - ğŸ”’ å®‰å…¨æ€§ï¼šå¯†é’¥éš”ç¦»ï¼Œå‰ç«¯æ— æ³•è®¿é—®
   - ğŸ¯ èŒè´£åˆ†ç¦»ï¼šå‰ç«¯è´Ÿè´£ UIï¼Œåç«¯è´Ÿè´£ä¸šåŠ¡é€»è¾‘
   - ğŸ”„ çµæ´»æ€§ï¼šç®¡ç†å‘˜å¯ä»¥é…ç½®æ–°æ¨¡å‹ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 

**ç»“è®ºï¼šå½“å‰æ¶æ„å®Œå…¨å®‰å…¨ï¼ŒAPI å¯†é’¥ä¸ä¼šæš´éœ²åœ¨å‰ç«¯ã€‚**


